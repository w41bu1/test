---
title: CVE-2024-4439 Analysis & POC
description: Security Vulnerability in WordPress Core.
date: 2025-10-03 12:00:00 +0700
categories: [Vulnerabilities, CVE Analyst]
tags: [analyst, core, xss]
image:
  path: assets/img/posts/2025-10-03-CVE-2024-4439/app.png
  alt: Illustration for CVE-2024-4439 analysis and proof-of-concept
---

---

## CVE & Basic Info
**WordPress Core** dễ bị **Stored Cross-Site Scripting** thông qua tên hiển thị người dùng trong **Avatar block** ở nhiều phiên bản **đến 6.5.2** do **insufficient output escaping** trên **display name**. Điều này cho phép **authenticated attackers**, có quyền **contributor-level access** trở lên, **inject arbitrary web scripts** vào các trang — những script này sẽ **thực thi** mỗi khi người dùng truy cập trang đã bị chèn. Ngoài ra, nó cũng cho phép **unauthenticated attackers** **inject arbitrary web scripts** vào những trang có **comment block** và hiển thị **comment author's avatar**.

* **CVE ID**: [CVE-2024-4439](https://www.cve.org/CVERecord?id=CVE-2024-4439)
* **Vulnerability Type**: Cross Site Scripting (XSS)
* **Affected Versions**:
  * 6.0 - 6.0.7
  * 6.1 - 6.1.5
  * 6.2 - 6.2.4
  * 6.3 - 6.3.3
  * 6.4 - 6.4.3
  * 6.5 - 6.5.1 
* **Patched Versions**: 
  * 6.0.8
  * 6.1.6
  * 6.2.5
  * 6.3.4
  * 6.4.4
  * 6.5.2
* **CVSS severity**: 7.2 (High)  
* **Required Privilege**: Contributor+
* **Product**: [WordPress](https://wordpress.org/)

---

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/posts/wordpress-local-and-debugging/).
* **Core versions**: **6.4.3** (vulnerable) và **6.4.4** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.

---

## Analysis

### Patch diff
Trong phiên bản **vulnerable**, WP Core đã sử dụng [`esc_attr__()`](https://developer.wordpress.org/reference/functions/esc_attr__/) để dịch chuỗi và escape HTML attribute trước khi hiển thị ra browser, nhưng đã triễn khai sai cách.

```php
$label = 'aria-label="' . sprintf( esc_attr__( '(%s author archive, opens in a new tab)' ), $author_name ) . '"';
```
{: file="wp-includes/blocks/avatar.php v6.4.3"}

`esc_attr__()` sau khi dịch chuỗi và escape HTML thì mới đưa vào `sprintf()` để chèn biến `$author_name` => `$author_name` không được xử lý.

Trong phiên bản **patched**, `$author_name` được đưa vào `sprintf()` trước và sau đó mới được escape HTML bằng `esc_attr()` => an toàn trước XSS.
```php
$label = 'aria-label="' . esc_attr( sprintf( __( '(%s author archive, opens in a new tab)' ), $author_name ) ) . '"';
```
{: file="wp-includes/blocks/avatar.php v6.4.4"}

![So sánh sự thay đổi giữa bản lỗi và bản vá](assets/img/posts/2025-10-03-CVE-2024-4439/dif1.png)
_So sánh sự thay đổi giữa bản lỗi và bản vá_

### Vulnerable code 

```php
function render_block_core_avatar( $attributes, $content, $block ) {
  // other logic
  if ( ! isset( $block->context['commentId'] ) ) {
    $author_id   = isset( $attributes['userId'] ) ? $attributes['userId'] : get_post_field( 'post_author', $block->context['postId'] );
    $author_name = get_the_author_meta( 'display_name', $author_id );
    // other logic
    if ( isset( $attributes['isLink'] ) && $attributes['isLink'] ) {
      $label = '';
      if ( '_blank' === $attributes['linkTarget'] ) {
        // translators: %s is the Author name.
        $label = 'aria-label="' . sprintf( esc_attr__( '(%s author archive, opens in a new tab)' ), $author_name ) . '"';
      }
    }
  }
  // other logic
}
```
{: file="wp-includes/blocks/avatar.php v6.4.3"}

**Avatar block** là 1 block của **Block Editor** dùng để tạo nội dung cho post hoặc comment trong WordPress.

`$author_name` là `display_name` của author có `$author_id` thuộc về post hiện tại.

Nếu đây là post và có link thì `$author_name` chứa payload sẽ thêm vào attribute `aria-label` và hiển thị ra trình duyệt.

Khi truy cập một post bất kỳ, `wp()` được gọi là lấy dữ liệu của post đó.

![Nơi bắt đầu lấy dữ liệu từ post hiện tại](assets/img/posts/2025-10-03-CVE-2024-4439/debug1.png)
_Nơi bắt đầu lấy dữ liệu từ post hiện tại_

```php
function wp( $query_vars = '' ) {
	global $wp, $wp_query, $wp_the_query;

	$wp->main( $query_vars );

	if ( ! isset( $wp_the_query ) ) {
		$wp_the_query = $wp_query;
	}
}
```
{: file="wp-includes/functions.php"}

Tại đây `$wp_query` mới được tạo và nó sẽ chứa giá trị của `wp_post` sau khi query.

```php
public function main( $query_args = '' ) {
  $this->init();

  $parsed = $this->parse_request( $query_args );

  if ( $parsed ) {
    $this->query_posts();
    $this->handle_404();
    $this->register_globals();
  }

  $this->send_headers();

  do_action_ref_array( 'wp', array( &$this ) );
}
```
{: file="wp-includes/class-wp.php"}

`main()` sẽ `parse_request` và thực hiện query lấy thông tin post hiện tại bằng `query_posts()`

![Lấy thông tin post bằng query_post()](assets/img/posts/2025-10-03-CVE-2024-4439/debug2.png)
_Lấy thông tin post bằng query_post()_

`$wp_the_query` là đối tượng **WP_Query chính** của WordPress, còn `$wp_query` chỉ đơn giản là một **tham chiếu** (reference) trỏ đến `$wp_the_query`. Vì vậy, khi `$wp_the_query` đã được khởi tạo và có dữ liệu, thì `$wp_query` cũng sẽ có cùng giá trị.

![Giá trị tham chiếu của $wp_query](assets/img/posts/2025-10-03-CVE-2024-4439/debug3.png)
_Giá trị tham chiếu của $wp_query_

Ta có được giá trị post_content:

```php
<!-- wp:avatar {"userId":2,"isLink":true,"linkTarget":"_blank"} /-->
```

`wp:avatar` thuộc loại block `core/avatar`

Hàm `render()` sẽ gọi đến `call_user_func()` với callback là `render_block_core_avatar()` để lấy HTML của Avatar block rồi trả về cho người dùng.

### Sources & Sinks

* **Source**: author name của contributor+ 
* **Sink**: `$author_name` được chèn vào attribute `aria-label`

---

## Exploit
### Proof of Concept (PoC)
- Tạo post account với role `contributor+` có chứa avatar block, bật tính năng **Link to user profile** và chọn user contributor.

![Tạo post với link to user profile được bật](assets/img/posts/2025-10-03-CVE-2024-4439/post1.png)
_Tạo post với link to user profile được bật_

- Thay đổi firstname chứa XSS payload và chọn display name là firstname

![Chọn display name chứa XSS payload](assets/img/posts/2025-10-03-CVE-2024-4439/disname.png)
_Chọn display name chứa XSS payload_

- Admin preview post => XSS xảy ra

![XSS xảy ra khi admin truy preview post](assets/img/posts/2025-10-03-CVE-2024-4439/xss1.png)
_XSS xảy ra khi admin truy preview post_

---

## Conclusion

Lỗ hổng **CVE-2024-4439** trong **WordPress Core <= 6.5.1** bắt nguồn từ việc sử dụng sai hàm `esc_attr__()` khi xử lý `display_name` trong **Avatar block**, dẫn đến **Stored XSS**. Kẻ tấn công có thể lợi dụng lỗ hổng này bằng cách chèn payload vào `display_name`, khiến script độc hại thực thi khi người dùng (bao gồm admin) truy cập trang chứa block. Bản vá trong **6.0.8, 6.1.6, 6.2.5, 6.3.4, 6.4.4, 6.5.2** đã thay đổi cách xử lý — escape sau khi format chuỗi bằng `sprintf()` — đảm bảo dữ liệu an toàn trước khi render ra browser.

**Key takeaways**:

* **Thứ tự escape rất quan trọng**: dữ liệu cần được **format trước**, rồi mới **escape** để tránh lọt XSS.
* Ngay cả **core functions** như `esc_attr__()` nếu dùng sai cách cũng có thể mở ra lỗ hổng nghiêm trọng.
* **Stored XSS** đặc biệt nguy hiểm vì nó tồn tại bền trong database và được kích hoạt bất kỳ khi nào người dùng truy cập.
* Không chỉ plugin/theme, mà **WordPress Core** cũng cần được **update thường xuyên** để giảm thiểu rủi ro bảo mật.
* Việc phân tích **patch diff** là cách hiệu quả để học cách lập trình an toàn và hiểu rõ nguồn gốc của lỗi.

---

## References

[Cross-site scripting (XSS) cheat sheet — PortSwigger](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

[WordPress Core <= effected_version_here — CVE-2024-4439](https://patchstack.com/patchstack_database_here)

--- 